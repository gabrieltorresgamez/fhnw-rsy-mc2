---
title: "RSY: MC2"
subtitle: "Studiengang Data Science (HS2022), FHNW"
author: "Jan Zwicky und Gabriel Torres"
date: "Letzte Aktualisierungen: `r format(Sys.time(), '%B %d, %Y')`"
output:
  bookdown::html_document2:
      code_folding: hide
      toc: true
      toc_depth: 3
      toc_float: true
      number_sections: true
editor_options: 
  chunk_output_type: console
---
<style>
#TOC {
  background-color: #F5F5F5;
  font-size: 16px;
}
#header{
  color: #708090;
  background-color: #F5F5F5;
  font-size: 30px;
}
body{
  color: #708090;
  background-color:#F5F5F5;
}
</style>

# Daten aufbereiten und Pakete Lesen
## Pakete laden und Daten einlesen
### Pakete laden
```{r setup, cache = TRUE, message = FALSE, warning = FALSE}
# Pakete für Data Wrangling und Visualisierung
library(tidyverse)

# Pakete für das HTML
library(bookdown)
library(knitr)

# Recommenderlab
library(recommenderlab)
```

###  Konfiguration der Pakete
```{r}
knitr::opts_chunk$set(fit.align = "left", cache = TRUE, warning = FALSE, message = FALSE)
set.seed(100)
```

### Daten einlesen und Samples erstellen
```{r}
movies1 <- read.csv("ml-latest-small/movies.csv", sep = ",")
links1 <- read.csv("ml-latest-small/links.csv", sep = ",")
ratings1 <- read.csv("ml-latest-small/ratings.csv", sep = ",")
tags1 <- read.csv("ml-latest-small/tags.csv", sep = ",")

# Sample von 70%
set.seed(69)
movies2 <- movies1 %>% slice_sample(prop = 0.7)
links2 <- subset(links1, movieId %in% movies2$movieId)
ratings2 <- subset(ratings1, movieId %in% movies2$movieId) %>% slice_sample(prop = 0.7)
tags2 <- subset(tags1, movieId %in% movies2$movieId)

# 2ter Sample von 70%
set.seed(100)
movies1 <- movies1 %>% slice_sample(prop = 0.7)
links1 <- subset(links1, movieId %in% movies1$movieId)
ratings1 <- subset(ratings1, movieId %in% movies1$movieId) %>% slice_sample(prop = 0.7)
tags1 <- subset(tags1, movieId %in% movies1$movieId)
```

## Vorbereitung der Daten
### Sample 1
```{r}
norm_ratings1 <- ratings1 %>%
  group_by(userId) %>%
  summarise(mean_rating = mean(rating), sd_rating = sd(rating)) %>%
  full_join(., ratings1, by = "userId")

norm_ratings1$z_rating <- (norm_ratings1$rating - norm_ratings1$mean_rating) /
  norm_ratings1$sd_rating

user_item1 <- norm_ratings1 %>%
  select(movieId, userId, z_rating) %>%
  pivot_wider(names_from = movieId, values_from = z_rating) %>%
  column_to_rownames(var = "userId")
```

### Sample 2
```{r}
norm_ratings2 <- ratings2 %>%
  group_by(userId) %>%
  summarise(mean_rating = mean(rating), sd_rating = sd(rating)) %>%
  full_join(., ratings2, by = "userId")

norm_ratings2$z_rating <- (norm_ratings2$rating - norm_ratings2$mean_rating) /
  norm_ratings2$sd_rating

user_item2 <- norm_ratings2 %>%
  select(movieId, userId, z_rating) %>%
  pivot_wider(names_from = movieId, values_from = z_rating) %>%
  column_to_rownames(var = "userId")
```

# Aufgaben
## Erzeugung von Film- & Nutzerprofilen
### Binäre User-Liked-Items Matrix f̈ür alle Nutzer erzeugen.
```{r}
user_item_binary1 <- user_item1 > 0
user_item_binary2 <- user_item2 > 0
```

### Dimension der User-Liked-Items Matrix prüfen und ausgeben.
```{r}
dim(user_item_binary1)
dim(user_item_binary2)
```

### Movie-Genre Matrix für alle Filme erzeugen. 
```{r}
movie_genres1 <- as.matrix(movies1 %>%
  separate_rows(genres, sep = "\\|", convert = FALSE) %>%
  replace(. == "", "no genres listed") %>%
  mutate(value = TRUE) %>%
  select(movieId, genres, value) %>%
  pivot_wider(names_from = genres, values_from = value, values_fill = FALSE) %>%
  column_to_rownames("movieId"))
movies_genres_rated1 <- movie_genres1[colnames(user_item_binary1), ]

movie_genres2 <- as.matrix(movies2 %>%
  separate_rows(genres, sep = "\\|", convert = FALSE) %>%
  replace(. == "", "no genres listed") %>%
  mutate(value = TRUE) %>%
  select(movieId, genres, value) %>%
  pivot_wider(names_from = genres, values_from = value, values_fill = FALSE) %>%
  column_to_rownames("movieId"))
movies_genres_rated2 <- movie_genres2[colnames(user_item_binary2), ]
```

## Dimension der Movie-Genre Matrix prüfen und ausgeben.
### All movies
```{r}
dim(movie_genres1)
dim(movie_genres2)
```

### Only rated movies
```{r}
dim(movies_genres_rated1)
dim(movies_genres_rated2)
```

## Anzahl unterschiedlicher Filmprofile bestimmen und visualisieren.
```{r}
movie_profile1 <- movie_genres1 %>%
  colSums() %>%
  as.list()
movie_profile1 <- tibble(genre = names(movie_profile1), count = unname(unlist(movie_profile1)))

movie_profile2 <- movie_genres2 %>%
  colSums() %>%
  as.list()
movie_profile2 <- tibble(genre = names(movie_profile2), count = unname(unlist(movie_profile2)))
```

```{r}
ggplot(movie_profile1, aes(count, genre)) +
  geom_col()

ggplot(movie_profile2, aes(count, genre)) +
  geom_col()
```

### Alternativ mit Kombinationen
```{r}
movie_profile1 <- movies1 %>%
  group_by(genres) %>%
  summarise(Anzahl_Filme = n())

number_profile1 <- nrow(movie_profile1)
sum_bottom1 <- movie_profile1 %>%
  arrange(Anzahl_Filme) %>%
  head(number_profile1 - 30) %>%
  summarise(genres = "combined", Anzahl_Filme = sum(Anzahl_Filme))

different_movies1 <- rbind(
  movie_profile1 %>%
    arrange(desc(Anzahl_Filme)) %>%
    head(30),
  sum_bottom1
) %>%
  mutate(genres = fct_reorder(genres, Anzahl_Filme))

ggplot(different_movies1, aes(Anzahl_Filme, factor(genres))) +
  geom_point()
```

```{r}
movie_profile2 <- movies2 %>%
  group_by(genres) %>%
  summarise(Anzahl_Filme = n())

number_profile2 <- nrow(movie_profile2)
sum_bottom2 <- movie_profile2 %>%
  arrange(Anzahl_Filme) %>%
  head(number_profile2 - 30) %>%
  summarise(genres = "combined", Anzahl_Filme = sum(Anzahl_Filme))

different_movies2 <- rbind(
  movie_profile2 %>%
    arrange(desc(Anzahl_Filme)) %>%
    head(30),
  sum_bottom2
) %>%
  mutate(genres = fct_reorder(genres, Anzahl_Filme))

ggplot(different_movies2, aes(Anzahl_Filme, factor(genres))) +
  geom_point()
```

## Nutzerprofile im Genre-Vektorraum erzeugen.
```{r}
# Variablen zur Berechnung
num_user <- dim(user_item_binary1)[1]
num_genres <- dim(movie_genres1)[2]
num_movies <- dim(user_item_binary1)[2]

# Intitialisierung der Matrix
user_profiles1 <- matrix(0, num_user, num_genres)
colnames(user_profiles1) <- colnames(movie_genres1)
rownames(user_profiles1) <- rownames(user_item_binary1)

# Jeder User wird einzeln berechnet.
for (user_index in rownames(user_profiles1)) {
  # User row wird gespeichert
  user <- user_item_binary1[user_index, ]
  # Anzahl der Bewertungen wird gespeichert
  num_ratings <- sum(!is.na(user))
  # Array mit dem index der liked movies wird erstellt
  liked_movies <- names(user[which(user == T)])
  # Häufigkeit der Genre likes wird berechnet
  if (length(liked_movies) == 1) {
    user_profiles1[user_index, ] <- movie_genres1[liked_movies, ] / num_ratings
  } else {
    user_profiles1[user_index, ] <- colSums(movie_genres1[liked_movies, ]) / num_ratings
  }
}

# remove clutter
remove(liked_movies)
remove(num_ratings)
remove(num_genres)
remove(num_movies)
remove(user_index)
remove(num_user)
remove(user)
```

```{r}
# Variablen zur Berechnung
num_user <- dim(user_item_binary2)[1]
num_genres <- dim(movie_genres2)[2]
num_movies <- dim(user_item_binary2)[2]

# Intitialisierung der Matrix
user_profiles2 <- matrix(0, num_user, num_genres)
colnames(user_profiles2) <- colnames(movie_genres2)
rownames(user_profiles2) <- rownames(user_item_binary2)

# Jeder User wird einzeln berechnet.
for (user_index in rownames(user_profiles2)) {
  # User row wird gespeichert
  user <- user_item_binary2[user_index, ]
  # Anzahl der Bewertungen wird gespeichert
  num_ratings <- sum(!is.na(user))
  # Array mit dem index der liked movies wird erstellt
  liked_movies <- names(user[which(user == T)])
  # Häufigkeit der Genre likes wird berechnet
  if (length(liked_movies) == 1) {
    user_profiles2[user_index, ] <- movie_genres2[liked_movies, ] / num_ratings
  } else {
    user_profiles2[user_index, ] <- colSums(movie_genres2[liked_movies, ]) / num_ratings
  }
}

# remove clutter
remove(liked_movies)
remove(num_ratings)
remove(num_genres)
remove(num_movies)
remove(user_index)
remove(num_user)
remove(user)
```

## Dimension der User-Genre-Profil Matrix prüfen und ausgeben.
```{r}
dim(user_profiles1)
dim(user_profiles2)
```

### Stärke der Genre-Kombination vollständig (Berechnungen wiederhohlen)
```{r}


äuääääääää



user_item_complete <- as.matrix(left_join(movies1, norm_ratings1, by = "movieId") %>%
  select(movieId, userId, z_rating) %>%
  pivot_wider(names_from = movieId, values_from = z_rating) %>%
  filter(is.na(userId) == FALSE) %>%
  select(!userId))
user_item_complete[is.na(user_item_complete)] <- 0

user_genres_complete <- user_item_complete %*% movie_genres1

nrow(unique(user_genres_complete, margin = 1))
```
### Stärke der Genre-Kombination binär

```{r}
nrow(unique(user_genres, margin = 1))
```

# Ähnlichkeit von Nutzern und Filmen

## Cosinus-Ähnlichkeit zwischen User-Genre - und Movie-Genre-Matrix berechnen.
```{r}
# besprechen noch unklar
user_genres <- as(user_genres, "binaryRatingMatrix")
similarity(user_genres, method = "cosine")
```

## Dimension der Matrix der Cosinus-Ähnlichkeiten von Nutzern und Filmen prüfen uns ausgeben.

```{r}

```

## 5-Zahlen Statistik für Matrix der Cosinus-Ähnlichkeiten prüfen uns ausgeben.

```{r}

```
